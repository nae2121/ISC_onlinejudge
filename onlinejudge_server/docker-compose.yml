version: '3.8'
x-logging:
  &default-logging
  logging:
    driver: json-file
    options:
      max-size: 100M

services:
  server:
    image: judge0/judge0:1.13.1
    volumes:
      - ./judge0/judge0.conf:/judge0.conf:ro
    ports:
      - "2359:2358"
    privileged: true
    <<: *default-logging
    restart: always

  workers:
    image: judge0/judge0:1.13.1
    command: ["./scripts/workers"]
    volumes:
      - ./judge0/judge0.conf:/judge0.conf:ro
    privileged: true
    <<: *default-logging
    restart: always

  db:
    image: postgres:16.2
    env_file:
      - ./judge0/judge0.conf
    volumes:
      - judge0_data:/var/lib/postgresql/data/
    <<: *default-logging
    restart: always

  redis:
    image: redis:7.2.4
    command: [
      "bash", "-c",
      'docker-entrypoint.sh --appendonly no --requirepass "$$REDIS_PASSWORD"'
    ]
    env_file:
      - ./judge0/judge0.conf
    <<: *default-logging
    restart: always

  demo:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./judge0_flask:/app:ro
    ports:
      - "5000:5000"
    environment:
      - JUDGE0_URL=http://server:2358
      - APP_PUBLIC_URL=http://demo:5000
      - ENABLE_CALLBACKS=true
      - REDIS_URL=redis://redis:6379/0
    command: >
      sh -c "pip install --no-cache-dir flask requests redis && python3 app.py"
    depends_on:
      - server
      - redis
    <<: *default-logging
    restart: always

  web:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./code:/app
    ports:
      - "5174:5173"
    environment:
      - PYTHONUNBUFFERED=1
    command: sh -c "pip install --no-cache-dir -r requirements.txt && python app.py"
    depends_on:
      - demo
    <<: *default-logging
    restart: unless-stopped

volumes:
  judge0_data:

networks:
  default:
    driver: bridge